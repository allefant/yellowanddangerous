/* This file was generated by scramble.py. */
#line 1 "src/title.py"
#include "title.h"
#line 17
str menu_text = "\n"
    "Play\n"
    "Reset Room\n"
    "New Game\n"
    "    -Are you sure?\n"
    "    -\n"
    "    Delete savegame!\n"
    "    Continue Playing\n"
    "Settings\n"
    "    Controls\n"
    "        Gamepad\n"
    "        Left/Right\n"
    "            -Configure H axis\n"
    "            Left\n"
    "            Right\n"
    "            Done\n"
    "        Up/Down\n"
    "            -Configure V axis\n"
    "            Up\n"
    "            Down\n"
    "            Done\n"
    "        Jump/Pull\n"
    "            -Configure buttons\n"
    "            Jump/Pull\n"
    "            Menu\n"
    "            Done\n"
    "        Back\n"
    "    Audio\n"
    "        -Volume\n"
    "        Music\n"
    "        Sound\n"
    "        Back\n"
    "    Video\n"
    "        Fullscreen|Back to Windowed\n"
    "        Back\n"
    "    Back\n"
    "";
#line 55
static MenuScreen * menu;
static MenuScreen * menu_main;
static Block * block1;
static Block * block2;
static int moment;
static bool selected_blocking;
static bool finding_input;
static int finding_control;
static int finding_progress;
static void _find_control(int c);
static int _indentation(str x);
static void drawvol(int v, float x, float y);
static int volget(float mx);
static void music_volume(int i);
static void sound_volume(int i);
static void draw_title_animation(void);
#line 65
MenuScreen* menu_screen_new(void) {
    MenuScreen * self;
#line 66
    land_alloc(self);
    self->items = land_array_new();
    return self;
}
MenuScreenItem* menu_screen_add(MenuScreen * self, str text) {
    MenuScreenItem * item;
#line 71
    land_alloc(item);
    if (land_starts_with(text, "-")) {
        item->disabled = 1;
        text++;
    }
#line 75
    if (land_contains(text, "|")) {
        item->alternates = land_split(text, "|");
        text = land_array_get_nth(item->alternates, 0);
    }
#line 78
    if (land_equals(text, "Controls")) {
        if (global_use_touch_input) {
            text = "Touch";
        }
    }
#line 82
    item->text = text;
    land_array_add(self->items, item);
    return item;
}
bool menu_is(str x) {
    return land_equals(menu->name, x);
}
MenuScreenItem* menu_item_get(void) {
    return land_array_get_nth(menu->items, menu->selected);
}
bool menu_item_is(str x) {
    MenuScreenItem * item = menu_item_get();
    if (! item) {
        return 0;
    }
#line 96
    return land_equals(item->text, x);
}
void menu_screen_back(void) {
    if (menu_is("New Game")) {
        main_switch_to_game();
    }
#line 101
    else if (menu_is("Controls")) {
        menu_goto("Settings");
    }
#line 103
    else if (menu_is("Main")) {
        main_switch_to_game();
    }
#line 104
    else {
#line 106
        menu_goto("Main");
        save_info();
    }
}
#line 109
void menu_goto(str x) {
    if (land_equals(x, "Main")) {
        menu = menu_main;
#line 111
        return ;
    }
    {
#line 113
        LandArrayIterator __iter0__ = LandArrayIterator_first(menu_main->items);
#line 113
        for (MenuScreenItem * item = LandArrayIterator_item(menu_main->items, &__iter0__); LandArrayIterator_next(menu_main->items, &__iter0__); item = LandArrayIterator_item(menu_main->items, &__iter0__)) {
            if (land_equals(item->text, x)) {
                menu = item->target;
#line 115
                return ;
            }
        }
    }
#line 117
    {
#line 117
        LandArrayIterator __iter0__ = LandArrayIterator_first(menu->items);
#line 117
        for (MenuScreenItem * item = LandArrayIterator_item(menu->items, &__iter0__); LandArrayIterator_next(menu->items, &__iter0__); item = LandArrayIterator_item(menu->items, &__iter0__)) {
            if (land_equals(item->text, x)) {
                menu = item->target;
#line 119
                return ;
            }
        }
    }
#line 121
    print("Cannot goto menu %s", x);
}
void menu_goup(void) {
    menu = menu->parent;
}
void menu_select_next(int d) {
    int n = land_array_count(menu->items);
    for (int i = 0; i < n; i += 1) {
        menu->selected += d;
        if (menu->selected == - 1) {
#line 130
            menu->selected += n;
        }
#line 131
        if (menu->selected == n) {
#line 131
            menu->selected = 0;
        }
#line 132
        MenuScreenItem * msi = land_array_get_nth(menu->items, menu->selected);
        if (msi->disabled) {
#line 133
            continue;
        }
#line 134
        break;
    }
}
#line 136
void menu_sideways(int d) {
    if (menu_is("Audio")) {
        if (menu_item_is("Music")) {
            music_volume(global_a->music + d);
        }
#line 140
        if (menu_item_is("Sound")) {
            sound_volume(global_a->sound + d);
        }
    }
}
#line 143
void menu_select_position(int p) {
    menu->selected = p;
}
static void _find_control(int c) {
    finding_input = 1;
    finding_control = c;
    finding_progress = 0;
}
void menu_click(float x) {
    All * a = global_a;
#line 154
    MenuScreenItem * item = menu_item_get();
    if (item) {
        if (item->target) {
            if (menu_is("Controls")) {
                menu = item->target;
                menu_select_position(1);
                menu_click(0);
#line 160
                return ;
            }
#line 163
            if (menu_is("Main")) {
                if (menu_item_is("New Game")) {
                    a->code = 0;
                    a->godmode = 0;
                }
            }
#line 167
            menu = item->target;
#line 167
            return ;
        }
    }
#line 169
    if (menu_is("Left/Right")) {
        if (menu_item_is("Left")) {
#line 170
            _find_control(ControlLeft);
        }
#line 171
        if (menu_item_is("Right")) {
#line 171
            _find_control(ControlRight);
        }
#line 172
        if (menu_item_is("Done")) {
#line 172
            menu_goup();
        }
    }
#line 173
    else if (menu_is("Up/Down")) {
        if (menu_item_is("Up")) {
#line 174
            _find_control(ControlUp);
        }
#line 175
        if (menu_item_is("Down")) {
#line 175
            _find_control(ControlDown);
        }
#line 176
        if (menu_item_is("Done")) {
#line 176
            menu_goup();
        }
    }
#line 177
    else if (menu_is("Jump/Pull")) {
        if (menu_item_is("Jump/Pull")) {
#line 178
            _find_control(ControlJump);
        }
#line 179
        if (menu_item_is("Menu")) {
#line 179
            _find_control(ControlMenu);
        }
#line 180
        if (menu_item_is("Done")) {
#line 180
            menu_goup();
        }
    }
#line 181
    else if (menu_is("Settings")) {
        if (menu_item_is("Touch")) {
            a->dpad++;
            if (a->dpad == 6) {
                a->dpad = 0;
            }
        }
    }
#line 186
    else if (menu_is("Audio")) {
        if (menu_item_is("Music")) {
            music_volume(volget(x));
        }
#line 189
        else if (menu_item_is("Sound")) {
            sound_volume(volget(x));
        }
    }
#line 191
    else if (menu_is("Video")) {
        if (menu_item_is("Fullscreen")) {
            land_display_toggle_fullscreen();
            a->fullscreen = (land_display_flags() & LAND_FULLSCREEN) != 0;
            item->choice = a->fullscreen ? 1 : 0;
        }
    }
#line 196
    else if (menu_is("New Game")) {
        if (menu_item_is("Delete savegame!")) {
            // start new game
            save_new();
            main_switch_to_game();
        }
#line 201
        else if (menu_item_is("Continue Playing")) {
            main_switch_to_game();
        }
    }
#line 203
    else if (menu_is("Controls")) {
#line 203
        ;
    }
    else if (menu_is("Main")) {
        if (menu_item_is("Play")) {
            if (global_can_enable_editor && volget(x) > 0) {
                a->editor_enabled = 1;
                a->editor = 1;
            }
#line 209
            else {
#line 211
                a->editor_enabled = 0;
            }
            // load saved game
            main_switch_to_game();
        }
#line 215
        else if (menu_item_is("Reset Room")) {
            // reset the current room
            save_reset_room(game->level);
            main_switch_to_game();
            if (game->player) {
                player_find_entrance(& game->player->super);
            }
        }
    }
#line 222
    if (menu_item_is("Back")) {
        menu_screen_back();
    }
}
#line 225
static int _indentation(str x) {
    int i = 0;
    while (x [i] == ' ') {
        i++;
    }
#line 229
    return i;
}
void title_init(void) {
    MenuScreen * menus [100];
    menus [0] = menu_main = menu_screen_new();
    menu_main->name = "Main";
    LandArray * rows = land_split_lines(menu_text);
    int prev_nested = 0;
    MenuScreenItem * prev_item = NULL;
    MenuScreen * prev_menu = NULL;
    {
#line 239
        LandArrayIterator __iter0__ = LandArrayIterator_first(rows);
#line 239
        for (str row_raw = LandArrayIterator_item(rows, &__iter0__); LandArrayIterator_next(rows, &__iter0__); row_raw = LandArrayIterator_item(rows, &__iter0__)) {
            int nested = _indentation(row_raw);
            if (nested > prev_nested) {
                menus [nested] = menu_screen_new();
                menus [nested]->name = prev_item->text;
                if (! land_equals(prev_item->text, "Touch")) {
                    prev_item->target = menus [nested];
                }
#line 246
                menus [nested]->parent = prev_menu;
            }
#line 247
            prev_nested = nested;
            prev_menu = menus [nested];
            char * row = land_strdup(row_raw);
            land_strip(& row);
            if (! row [0]) {
#line 251
                continue;
            }
#line 252
            prev_item = menu_screen_add(menus [nested], row);
        }
    }
#line 254
    land_array_destroy_with_strings(rows);
#line 256
    menu = menu_main;
}
int get_line(float y) {
    float w = land_display_width();
    float h = land_display_height();
    double s = w / 960;
    h /= s;
#line 264
    float by = (h - 64 * 5) / 2;
    y /= s;
    y -= by;
    y /= 64;
#line 269
    return y;
}
// 0 = main, 1 = settings
void title_com(int com) {
    if (com == 1) {
        menu_goto("Settings");
    }
#line 274
    else {
#line 276
        menu_goto("Main");
    }
}
#line 278
void title_tick(void) {
    float w = land_display_width();
    float h = land_display_height();
    double s = w / 960;
    h /= s;
#line 284
    All * a = global_a;
#line 286
    if (finding_input) {
        int status = config_joystick_control(finding_control, finding_progress);
        if (status == FoundButton) {
            finding_input = 0;
        }
#line 290
        if (status == FoundAxis) {
            finding_progress++;
        }
#line 292
        if (status == FoundNothing) {
            // wait until they stop using the input
#line 293
            if (finding_progress >= 10) {
                finding_input = 0;
            }
        }
#line 295
        if (! finding_input) {
            menu_select_next(1);
            menu_click(0) /* either next control or done */;
        }
#line 297
        return ;
    }
#line 300
    if (land_key_pressed(LandKeyBack) || controls.pressed [ControlMenu]) {
        menu_screen_back();
    }
    if (selected_blocking) {
        if (! a->up && ! a->down && ! a->left && ! a->right) {
            selected_blocking = 0;
        }
    }
#line 306
    else if (a->up || a->down) {
        menu_select_next(a->up ? - 1 : 1);
        selected_blocking = 1;
    }
#line 309
    else if (a->left || a->right) {
        menu_sideways(a->left ? - 1 : 1);
        selected_blocking = 1;
    }
    for (int ti = 0; ti < 12; ti += 1) {
        bool click = 0;
        int i = 0;
        int i2 = 0;
        float x = 0;
        if (ti < 11) {
            if (land_touch_down(ti) && land_touch_delta(ti)) {
                click = 1;
            }
#line 321
            i2 = get_line(land_touch_y(ti));
            i = i2;
            if (i > 0) {
#line 323
                i--;
            }
#line 324
            x = land_touch_x(ti);
        }
#line 324
        else {
#line 326
            if (controls.pressed [ControlJump]) {
                i = menu->selected;
                click = 1;
            }
        }
#line 330
        if (click) {
            if (i2 == 1) {
                if (menu_is("New Game")) {
                    a->code++;
                    if (a->code == 7) {
                        sound(Render_glass, 1);
                        a->godmode = 1;
                    }
                }
            }
#line 336
            else {
#line 338
                menu_select_position(i);
                menu_click(x);
            }
        }
    }
}
#line 341
static int volx = 0;
static void drawvol(int v, float x, float y) {
    LandColor c = land_color_get();
    y += 16;
    float s = 48;
    for (int i = 0; i < 7; i += 1) {
        float ix = x + i * s;
        float iy = y;
        land_color(1, 1, 1, 1);
        if (i <= v) {
            if (v == 0) {
                land_color(0, 0, 0, 1);
            }
#line 353
            land_filled_rectangle(ix, iy, ix + s * 0.8, iy + s);
        }
#line 353
        else {
#line 355
            float cx = ix + s * 0.4;
            float cy = iy + s * 0.5;
            land_filled_circle(cx - 4, cy - 4, cx + 4, cy + 4);
        }
    }
#line 358
    land_color_set(c);
}
void menu_screen_draw(void) {
    All * a = global_a;
    float w = land_display_width();
    float h = land_display_height();
    double s = w / 960;
    h /= s;
    land_font_set(a->big);
    float th = land_line_height();
    float yw = land_text_get_width("Yellow ");
    land_color(.9, .9, 0.7, 1);
    float tx = (960 - land_text_get_width("Yellow and Dangerous")) / 2;
#line 372
    int it = 0;
    {
#line 373
        LandArrayIterator __iter0__ = LandArrayIterator_first(menu->items);
#line 373
        for (MenuScreenItem * item = LandArrayIterator_item(menu->items, &__iter0__); LandArrayIterator_next(menu->items, &__iter0__); item = LandArrayIterator_item(menu->items, &__iter0__)) {
            int it2 = it;
            if (it2 > 0) {
                it2++;
            }
#line 377
            float y = (h - 64 * 5) / 2 + it2 * 64 + (32 - th) / 2;
            float x = tx;
            bool draw = 1;
            land_text_pos(x + yw, y);
            land_color(0.5, 0, 0, 1);
            if (it == menu->selected) {
                land_color(0.9, 0.1, 0, 1);
                if (finding_input) {
                    if ((land_get_ticks() / 5) % 2 == 0) {
                        land_color(1, 1, 1, 1);
                    }
                }
            }
#line 386
            else {
#line 388
                land_color(0.5, 0, 0, 1);
            }
            if (menu_is("Settings")) {
                if (it == 0) {
                    if (global_use_touch_input) {
                        if (a->dpad == 0) {
#line 393
                            land_print("DPad left");
                        }
#line 394
                        if (a->dpad == 1) {
#line 394
                            land_print("DPad right");
                        }
#line 395
                        if (a->dpad == 2) {
#line 395
                            land_print("DPad left big");
                        }
#line 396
                        if (a->dpad == 3) {
#line 396
                            land_print("DPad right big");
                        }
#line 397
                        if (a->dpad == 4) {
#line 397
                            land_print("double click swipe");
                        }
#line 398
                        if (a->dpad == 5) {
#line 398
                            land_print("two finger swipe");
                        }
#line 399
                        draw = 0;
                    }
                }
            }
#line 400
            else if (menu_is("Audio")) {
                if (it == 1) {
                    drawvol(a->music, volx, y);
                }
#line 403
                else if (it == 2) {
                    drawvol(a->sound, volx, y);
                }
            }
#line 405
            else if (menu_is("New Game")) {
                if (it == 0) {
                    land_color(1, 0.75, 0.75, 1);
                }
#line 408
                else if (it == 2) {
                    if (it == menu->selected) {
                        land_color(1, 0.4, 0.4, 1);
                    }
                }
#line 411
                else if (it == 3) {
                    if (it == menu->selected) {
                        land_color(0, 0.5, 0, 1);
                    }
                }
            }
#line 415
            if (draw) {
                if (item->alternates) {
#line 418
                    land_print(land_array_get_nth(item->alternates, item->choice));
                }
#line 418
                else {
#line 420
                    land_print(item->text);
                }
            }
#line 422
            if (menu_is("Main")) {
                if (it == 0) {
                    if (global_can_enable_editor) {
                        land_text_pos(volx + 48, y);
                        land_print("Edit");
                    }
                }
            }
#line 428
            int control = ControlNone;
            if (menu_is("Left/Right")) {
                if (it == 1) {
#line 430
                    control = ControlLeft;
                }
#line 431
                if (it == 2) {
#line 431
                    control = ControlRight;
                }
            }
#line 432
            if (menu_is("Up/Down")) {
                if (it == 1) {
#line 433
                    control = ControlUp;
                }
#line 434
                if (it == 2) {
#line 434
                    control = ControlDown;
                }
            }
#line 435
            if (menu_is("Jump/Pull")) {
                if (it == 1) {
#line 436
                    control = ControlJump;
                }
#line 437
                if (it == 2) {
#line 437
                    control = ControlMenu;
                }
            }
#line 438
            if (menu_is("Controls")) {
                if (it == 1) {
#line 439
                    control = ControlLeft;
                }
#line 440
                if (it == 2) {
#line 440
                    control = ControlUp;
                }
#line 441
                if (it == 3) {
#line 441
                    control = ControlJump;
                }
            }
#line 443
            if (control) {
                land_font_set(a->medium);
                land_text_pos(volx + 68, y);
                land_color(0, 0, 0, 0.33);
                land_print(control_name(control));
                land_font_set(a->big);
            }
            it++;
        }
    }
}
#line 452
static int volget(float mx) {
    float w = land_display_width();
    double s = w / 960;
    float sx = 48;
    mx /= s;
    int i = (mx - volx) / sx;
    return i;
}
static void music_volume(int i) {
    if (i < 0) {
#line 461
        i = 0;
    }
#line 462
    if (i > 6) {
#line 462
        i = 6;
    }
#line 463
    global_a->music = i;
    song_volume();
}
static void sound_volume(int i) {
    if (i < 0) {
#line 467
        i = 0;
    }
#line 468
    if (i > 6) {
#line 468
        i = 6;
    }
#line 469
    global_a->sound = i;
    sound(Render_on, 1);
}
float align(float x, float s) {
    return floor(x * s) / s;
}
void title_render(void) {
    All * a = global_a;
    float w = land_display_width();
    float h = land_display_height();
    double s = w / 960;
    h /= s;
    land_clear(1, 1, 1, 1);
#line 483
    land_reset_transform();
    land_scale(s, s);
#line 486
    land_font_set(a->big);
    float th = land_line_height();
    float yw = land_text_get_width("Yellow ");
#line 490
    land_color(.9, .9, 0.7, 1);
    float tx = (960 - land_text_get_width("Yellow and Dangerous")) / 2;
    land_filled_rectangle(tx + yw, 0, 960, h);
#line 494
    if (menu_is("Settings")) {
        land_font_set(a->medium);
        land_color(0.5, 0, 0, 1);
        float nh = land_line_height();
        float y = (h - 64 * 5) / 2 + (32 - th) / 2;
        float x = tx;
        land_text_pos(x + yw, y - nh * 2);
        if (global_use_touch_input) {
            if (a->dpad == 5) {
                land_print("Jump: touch second finger");
                land_print("Pull/Lift: two finger swipe");
            }
#line 505
            else if (a->dpad == 4) {
                land_print("Jump: Move then double tap");
                land_print("Pull/Lift: Double tap then move");
            }
#line 507
            else {
#line 509
                land_print("Jump: Hold move then jump");
                land_print("Pull/Lift: Hold jump then move");
            }
        }
#line 510
        else {
#line 512
            land_print("Jump: Press button while moving");
            land_print("Pull/Lift: Press button first then move");
        }
#line 514
        land_font_set(a->big);
    }
    volx = tx + yw + 6 * 32;
#line 518
    if (1) {
        int i = 1;
        float y = (h - 64 * 5) / 2 + i * 64 + (32 - th) / 2;
        float x = tx;
        land_color(1, 0.9, 0, 1);
        land_text_pos(x, y);
        land_write("Yellow ");
        land_color(1, 1, 1, 1);
        if ((land_get_ticks() / 60) % 14 >= 7) {
            if (land_get_ticks() % 8 >= 4) {
                land_color(1, 1, 0, 1);
            }
        }
#line 529
        land_print("and Dangerous");
    }
    menu_screen_draw();
#line 533
    land_font_set(a->font);
    land_color(0, 0, 0, 1);
#line 536
    if (! block1) {
        block1 = block_new(game->blocks, 120, 0, 720, Render_Gremlin);
    }
#line 538
    if (! block2) {
        block2 = block_new(game->blocks, - 660, 0, - 60, Render_Allefant);
    }
    moment++;
    if (moment > 4) {
        // wait a moment so Android gets a moment to recover and
        // won't crash :P
        draw_title_animation();
    }
    a->tint.a = 0;
#line 549
    land_font_set(a->font);
    land_text_pos(w / s, h - land_line_height() * 6);
    int t = a->time / 60;
    int f = 0;
    for (int i = 0; i < 8; i += 1) {
        if (game->flower [i]) {
            f++;
        }
    }
#line 556
    int tt = 0;
    for (int i = 0; i < 8; i += 1) {
        if (game->test_tube [i]) {
            tt++;
        }
    }
#line 560
    land_print_right("Flowers picked: %d/7", f);
    land_print_right("Test tubes: %d/7", tt);
    land_print_right("Car keys found: %s", game->key ? "yes" : "no");
    land_print_right("Died %d time%s.", game->deaths, game->deaths != 1 ? "s" : "");
#line 565
    land_print_right("Playtime on this savegame: %02d:%02d:%02d", t / 3600, (t / 60) % 60, t % 60);
    land_print_right("Version %s", VERSION);
}
static void draw_title_animation(void) {
    All * a = global_a;
    float speed = 60 * 7 / 2.0;
    for (int i = 0; i < 7; i += 1) {
        float ang = (land_get_ticks() + i * speed / 7) * 2 * pi / speed;
        block1->y = 60 * fabs(sin(ang * 3.5));
        block1->x = 0 + cos(ang) * 120;
        block1->z = 600 + sin(ang) * 120;
        block1->frame = ((land_get_ticks() / 30 + i) % 4) * 4;
        if (((land_get_ticks() / 60) % 14 >= 7) && i == 0) {
            a->tint = land_color_hsv((land_get_ticks() * 4) % 360, .25, 1);
            a->tint.a = 0.5;
            a->tint.r *= a->tint.a;
            a->tint.g *= a->tint.a;
            a->tint.b *= a->tint.a;
        }
#line 582
        else {
#line 584
            a->tint = land_color_premul(1, 1, 1, .2);
        }
#line 585
        if (! blocktype_preload(block1->block_type)) {
            render_block(block1, game->viewport);
        }
    }
#line 588
    a->tint = land_color_premul(1, 1, 1, .2);
#line 590
    block2->frame = 8 + ((16 * land_get_ticks() / 60) % 8);
    if (! blocktype_preload(block2->block_type)) {
        render_block(block2, game->viewport);
    }
}
/* This file was generated by scramble.py. */
